<html>
<head>
	<style type="text/css">
		body {
			margin: 0;
			padding: 10px;
			border: 10px solid rgba(0,0,0,0);
		}
		body.paused {
			border: 10px solid yellow;
		}
		.icon {
			width: 16px;
			height: 16px;
			border: none;
			padding: 3px;
			vertical-align: middle;
		}
		.icon:hover, icon:focus {
			border: dashed lightgrey 3px;
			padding:  0px;
		}

		#splits {
			list-style-type: none;
		}
		.split .time {
			display: inline-block;
			min-width: 70px;
		}
		.split .name {
			display: inline-block;
		}
		.split .icon {
			margin-left: 10px;
		}

		#currentSplit div {
			display: inline-block;
		}
		#currentSplit .name {
			min-width: 60px;
		}


		#totalTime div {
			display: inline-block;
		}
		#totalTime .name {
			min-width: 60px;
		}

		button {
			text-transform: uppercase;
		}
		#copyAll {
			vertical-align: text-bottom;
		}

		input[type=text] {
			border: dashed 1px;
		}
		input[type=text]:focus {
			border: initial;
			padding: 3px;
		}
		.info {
			white-space: pre;
			border: 1px dashed lightgrey;
			padding: 5px 10px 5px 10px;
			display: inline-block;
		}
	</style>
</head>
<body>
	<div>Splits<img id='copyAll' title='Copy all' class='icon' src='copy.png'></div> <ol id='splits'></ol>
	<div id='currentSplit'><div class='name'>Current</div><div class='time'></div></div>
	<div id='totalTime'><div class='name'>Total</div><div class='time'></div></div>
	<button name='reset'>reset</button>
	<button name='pause'>pause</button>
	<button name='split'>split</button>
	<br/><br/><br/>
	<div class='info'><strong>Info</strong>
• Click descriptions to edit.
• Global shortcut 'spacebar' to split (when not editing description).
• <img id='copyAll' class='icon' src='copy.png'> copies to clipboard.</div>
	<script>
		function timeBetween(start, end) {
			var delta = (end - start);
			var millis = Math.floor(delta%1000);
			var seconds = Math.floor(delta/1000)%60;
			var minutes = Math.floor((delta/(60*1000))%60);
			var hours = Math.floor((delta/(60*60*1000))%24);
			var days = Math.floor((delta/(60*60*1000))/24);
			return {
				millis,
				seconds,
				minutes,
				hours,
				days
			};
		}
		function formatTimeDelta(from, to) {
			const delta = timeBetween(from, to);
			const formatted = `${delta.days}:${delta.hours}:${delta.minutes}:${delta.seconds}`;
			return formatted;
		}
		function TimeCode(time, name) {
			return { id:(++timecodeIdCounter) , time, name };
		}

		let timer = null;
		let fullPrecisionPreviousTime = Date.now();
		let fullPrecisionCurrentTime = Date.now();
		let now = Date.now();
		let timecodeIdCounter = 0;
		let timecodes = [];

		function renderCurrentSplit() {
			document.querySelector('#currentSplit .time').textContent = formatTimeDelta(timecodes[timecodes.length-1].time, now);
		}
		function renderTotalTime() {
			document.querySelector('#totalTime .time').textContent = formatTimeDelta(timecodes[0].time, now);
		}
		function renderTimeCodeClipboardItem(timecode) {
			const payload = {
				...timecode,
				formattedTime: formatTimeDelta(timecodes[0].time, timecode.time) 
			};
			return payload;
		}
		function onCopyAll() {
			const rendered = timecodes.map(x => renderTimeCodeClipboardItem(x));
			const payload = {
				splits: rendered
			};
			navigator.clipboard.writeText(JSON.stringify(payload));
		}
		function onSplitNameChange(e, id) {
			var index = timecodes.findIndex(x => x.id === id);
			const timecode = timecodes[index];
			timecode.name = e.currentTarget.value;
		}
		function onSplitCopy(id) {
			var index = timecodes.findIndex(x => x.id === id);
			const timecode = timecodes[index];
			const payload = renderTimeCodeClipboardItem(timecode);
			navigator.clipboard.writeText(JSON.stringify(payload));
		}
		function onSplitDelete(id) {
			var index = timecodes.findIndex(x => x.id === id);
			timecodes.splice(index, 1);

			var split = document.querySelector(`#splits > #split-${id}`);
			split.remove();
		}
		function renderSplit(timecode) {
			const split = document.createElement('div');
			split.id = `split-${timecode.id}`;
			split.className = 'split';

			const splitTime = document.createElement('div');
			splitTime.className = 'time';
			splitTime.textContent = formatTimeDelta(timecodes[0].time, timecode.time);
			split.appendChild(splitTime);

			const splitName = document.createElement('input');
			splitName.type = 'text';
			splitName.className = 'name';
			splitName.value = timecode.name;
			splitName.addEventListener('change', (e) => onSplitNameChange(e, timecode.id));
			split.appendChild(splitName);

			const copyButton = document.createElement('img');
			copyButton.className = 'icon copy';
			copyButton.src = 'copy.png';
			copyButton.title = 'Copy';
			copyButton.addEventListener('click', () => onSplitCopy(timecode.id));
			split.appendChild(copyButton);

			if (timecode !== timecodes[0]) {
				const deleteButton = document.createElement('img');
				deleteButton.className = 'icon delete';
				deleteButton.src = 'delete.png';
				deleteButton.addEventListener('click', () => onSplitDelete(timecode.id));
				split.appendChild(deleteButton);
			}

			return split;
		}
		function render() {
			renderCurrentSplit();
			renderTotalTime();
		}
		function doSplit(name) {
			const timecode = TimeCode(now, name||`new split`);
			timecodes.push(timecode);
			const splits = document.querySelector('#splits');
			splits.appendChild(renderSplit(timecode));
		}
		function doReset() {
			timecodes = [];
			update();
			document.querySelector('#splits').innerHTML = '';
			doSplit('The Beginning Of Time');
		}
		function update() {
			const n = Date.now();
			const delta = n - fullPrecisionPreviousTime;
			fullPrecisionPreviousTime = n;
			fullPrecisionCurrentTime += delta;
			now = Math.floor(fullPrecisionCurrentTime/1000)*1000;
		}
		function doPause() {
			if (timer) {
				timer = clearInterval(timer);
				document.body.className = 'paused';
				document.querySelector('button[name=pause]').textContent = 'unpause';
			} else {
				fullPrecisionPreviousTime = Date.now();
				timer = setInterval(function() {
					update();
					render();
				}, 100);
				document.body.className = 'running';
				document.querySelector('button[name=pause]').textContent = 'pause';
			}
		}

		function onkeypress(e) {
			if (e.charCode == 32 && document.activeElement == document.body) {
				doSplit();
			}
		}

		document.addEventListener('keypress', onkeypress);
		document.querySelector('#copyAll').addEventListener('click', () => onCopyAll());
		document.querySelector('button[name=split]').addEventListener('click', (e) => {
			doSplit();
			e.currentTarget.blur(); // reserve focus for global split toggle shortcut
		});
		document.querySelector('button[name=reset]').addEventListener('click', (e) => {
			doReset()
			e.currentTarget.blur();
		});
		document.querySelector('button[name=pause]').addEventListener('click', (e) => {
			doPause()
			e.currentTarget.blur();
		});

		doReset();
		doPause();
	</script>
</body>
</html>	
