<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="light.theme.css">
	<link rel="stylesheet" type="text/css" href="dark.theme.css">
	<link rel="stylesheet" type="text/css" href="table.css">
	<link rel="stylesheet" type="text/css" href="tabs.css">
	<link rel="stylesheet" type="text/css" href="config.css">
	<style type="text/css">
		body {
			margin: 0;
			padding: 10px;
			border: 10px solid rgba(0,0,0,0);
			background-color: var(--theme-background-color);
			color: var(--theme-text-color);
		}
		body.paused {
			border: 10px solid;
			border-color: var(--theme-splits-paused-border-color);
		}
		.icon {
			width: 16px;
			height: 16px;
			vertical-align: middle;
			user-select: none;
		}

		#splits {
			list-style-type: none;
		}
		.split .time {
			display: inline-block;
			min-width: 70px;
			text-align: center;
		}
		.split .dec {
			display: inline-block;
		}
		.split .inc {
			display: inline-block;
		}
		.split .label {
			display: inline-block;
			margin-left: 10px;
		}
		.split .icon {
			margin-left: 10px;
		}

		#currentSplit div {
			display: inline-block;
		}
		#currentSplit .name {
			min-width: 60px;
		}


		#totalTime div {
			display: inline-block;
		}
		#totalTime .name {
			min-width: 60px;
		}

		button {
			text-transform: uppercase;
			background-color: var(--theme-button-background-color);
			color: var(--theme-button-text-color);
			cursor: pointer;
		}
		button:hover, button:focus {
			background-color: var(--theme-button-hover-background-color);
		}
		.button {
			border: var(--theme-button-like-border);
			padding: var(--theme-button-like-padding);
			cursor: pointer;
			user-select: none;
		}
		.button:hover, .button:focus {
			border: var(--theme-button-like-hover-border);
			padding:  var(--theme-button-like-hover-padding);
		}


		#copyAll {
			vertical-align: text-bottom;
		}

		input[type=text], input[type=number], textarea {
			border: dashed 1px;
			background-color: var(--theme-input-background-color);
			color: var(--theme-input-text-color);
			outline: none;
		}
		input[type=text]:focus:not([readonly]), input[type=number]:focus:focus:not([readonly]), textarea:focus:focus:not([readonly]) {
			border: initial;
			outline: revert;
			padding: 2px 3px;
		}
		.info {
			white-space: pre;
			border: 1px dashed lightgrey;
			padding: 5px 10px 5px 10px;
			display: inline-block;
		}
	</style>
</head>
<body>
	<div class='tabs'>
		<div class='tabBar'></div>
		<div class='tab active' data-title='splits'>
			<div>Splits</div>
			<div>Copy all<span id='copyAll'></span></div>
			<ol id='splits'></ol>
			<div id='currentSplit'><div class='name'>Current</div><div class='time'></div></div>
			<div id='totalTime'><div class='name'>Total</div><div class='time'></div></div>
			<button name='reset'>reset</button>
			<button name='pause'>pause</button>
			<button name='split'>split</button>
		</div>
		<div class='tab' data-title='info'>
			<div class='info'><strong>Info</strong>
• Click descriptions to edit.
• Global shortcut 'spacebar' to split (when not editing description).
• <img class='button icon' src='copy.png'> copies to clipboard.</div>
		</div>
		<div class='tab' data-title='config'>
			<div class='table config'>
				<div class='tr'><div class='td name'><strong>Dark mode</strong></div><div class='td value'><input type='checkbox' name='darkMode' checked></div></div>
				<div class='tr'><div class='td name'><strong>Start on load</strong></div><div class='td value'><input type='checkbox' name='startOnLoad'></div></div>
				<div class='tr'><div class='td name'><strong>Autosave</strong></div><div class='td value'><input type='checkbox' name='autosave' checked></div></div>
				<div class='tr'><div class='td name'><strong>First split name</strong></div><div class='td value'><input type='text' name='firstSplitName' value='The Beginning'></div></div>
				<div class='tr'><div class='td name'><strong>New split name</strong></div><div class='td value'><input type='text' name='newSplitName' value='New Split'></div></div>
				<div class='tr'><div class='td name'><strong>Manual increment</strong></div><div class='td value'><input type='number' name='manualIncrement' value='1'></div></div>
				<div class='tr'><div class='td name'><strong>Digit padding</strong></div><div class='td value'><input type='number' name='zeroPadding' value='2'></div></div>
				
				<div class='tr'>
					<div class='td name'>
						<div><strong>Export format</strong></div>
						Examples
						<div>
							<ul style='list-style-type: none; padding: 0; margin: 0'>
								<li><div>YoutTube</div><textarea type="text" readonly>[${(_.split.timeParts.days*24+_.split.timeParts.hours).toString().padStart(2,'0')}:${_.split.timeParts.minutes.toString().padStart(2,'0')}:${_.split.timeParts.seconds.toString().padStart(2,'0')}](https://www.youtube.com/myvideo#t=${(_.split.timeParts.days*24+_.split.timeParts.hours).toString().padStart(2,'0')}h${_.split.timeParts.minutes.toString().padStart(2,'0')}m${_.split.timeParts.seconds.toString().padStart(2,'0')}s) ${_.split.label}</textarea></li>
								<li><div>Markdown</div><textarea type="text" readonly>${(_.split.timeParts.days*24+_.split.timeParts.hours).toString().padStart(2,'0')}:${_.split.timeParts.minutes.toString().padStart(2,'0')}:${_.split.timeParts.seconds.toString().padStart(2,'0')}] ${_.split.label}</textarea></li>
							</ul>
						</div>
					</div>
					<div class='td value'>Enabled<input type='checkbox' name='export.1.enabled' checked>Name<input type='text' name='export.1.label' value='JSON'>Format<input type='text' name='export.1.format' value='${JSON.stringify(_.split)}'></div>
					<div class='td value'>Enabled<input type='checkbox' name='export.2.enabled' checked>Name<input type='text' name='export.2.label' value='Youtube'>Format<input type='text' name='export.2.format' value='https://www.youtube.com/myvideo#t=${_.split.timeParts.minutes}m${_.split.timeParts.seconds}'></div>
					<div class='td value'>Enabled<input type='checkbox' name='export.3.enabled' checked>Name<input type='text' name='export.3.label' value='Markdown'>Format<input type='text' name='export.3.format' value='[_.split.timeFormatted](https://www.youtube.com/myvideo#t=${_.split.timeParts.minutes}m${_.split.timeParts.seconds} ${_.split.label})'></div>
				</div>
			</div>
			<hr>
			<div style='position: relative'>
				<div>⛔️&nbsp;Consider your actions carefully&nbsp;⛔️</div>
				<div class='table config dangerzone'>
					<div class='tr'><div class='td name'><strong>Clear local storage</strong><br>Do you really want to do it? Reload afterward and let go of all your worries.</div><div class='td value'><button name='clearLocalStorage'>Clear Now</button></div></div>
					<div class='tr'><div class='td name'><strong>Always reload after clearing</strong><br>Offers peace of mind; not everyone is ready for it.</div><div class='td value'><input type='checkbox' name='peaceOfMind'></div></div>
				</div>
			</div>
		</div>
	</div>
	<script>
	</script>
	<script src='tabs.js'></script>
	<script src='config.js'></script>
	<script>
		function durationParts(delta) {
			var millis = Math.floor(delta%1000);
			var seconds = Math.floor(delta/1000)%60;
			var minutes = Math.floor((delta/(60*1000))%60);
			var hours = Math.floor((delta/(60*60*1000))%24);
			var days = Math.floor((delta/(60*60*1000))/24);
			return {
				millis,
				seconds,
				minutes,
				hours,
				days
			};
		}
		function formatTimeDelta(from, to) {
			const pad = x => x.toString().padStart(configs.getInt('zeroPadding'), '0');
			const delta = durationParts(to - from);
			const formatted = `${pad(delta.days)}:${pad(delta.hours)}:${pad(delta.minutes)}:${pad(delta.seconds)}`;
			return formatted;
		}
		function TimeCode(timestamp, label) {
			return { id:(++state.timecodeIdCounter) , timestamp, label };
		}

		const proxies = (() => {
			const fac = {};
			let _dirty = false;
			fac.dirty = d => {
				if (d && fac.onDirty) {
					fac.onDirty();
				}
				if (d != null) _dirty = d;
				return _dirty;
			};
			fac.create = target => {
				Object.keys(target)
					.filter(p => typeof(target[p]) === 'object')
					.forEach(p => target[p] = fac.create(target[p]));
				return new Proxy(target, {
					set: (o,p,v) => {
						if (typeof(v) === 'object')
							v = fac.create(v);
						o[p] = v;
						fac.dirty(true);
						return true;
					},
					deleteProperty: (o,p) => {
						delete o[p];
						fac.dirty(true);
						return true;
					}
				});
			};
			return fac;
		})();

		const storageData = Config('app');

		const previousState = (() => { try { return JSON.parse(storageData.getString('state')) || {}; } catch (e) { return {}; } })();

		let timer = null;
		let now = Date.now();

		const state = proxies.create({
			// defaults
			timecodeIdCounter: 0,
			timecodes: [],
			fullPrecisionPreviousTime: Date.now(),
			fullPrecisionCurrentTime: Date.now(),
			// override with loaded state
			...previousState
		});
		(() => {
			let debounceTimeout;
			proxies.onDirty = () => {
				if (!debounceTimeout)
					debounceTimeout = setTimeout(() => {
						debounceTimeout = null;
						if (configs.getBool('autosave'))
							storageData.setString('state', JSON.stringify(state));
					});
			};
		})();

		function renderCurrentSplit() {
			document.querySelector('#currentSplit .time').textContent = formatTimeDelta(state.timecodes[state.timecodes.length-1].timestamp, now);
		}
		function renderTotalTime() {
			document.querySelector('#totalTime .time').textContent = formatTimeDelta(state.timecodes[0].timestamp, now);
		}
		function renderTimecodeTemplate(template, timecode) {
			const payload = {
				split: {
					label: timecode.label,
					timeStamp: timecode.timestamp,
					timeParts: durationParts(timecode.timestamp - state.timecodes[0].timestamp),
					timeFormatted: formatTimeDelta(state.timecodes[0].timestamp, timecode.timestamp)
				}
			};
			const funcBody = `return \`${template.replaceAll('`', '\\`')}\`;`
			const render = new Function('_', funcBody);
			return render(payload).trim();
		}
		function renderTimeCodeClipboardItem(timecode, format) {
			return renderTimecodeTemplate(format, timecode);
		}
		function onCopyAll(format) {
			const rendered = state.timecodes.map(x => renderTimeCodeClipboardItem(x, format));
			navigator.clipboard.writeText(rendered.join('\n'));
		}
		function onSplitNameChange(e, id) {
			var index = state.timecodes.findIndex(x => x.id === id);
			const timecode = state.timecodes[index];
			timecode.label = e.currentTarget.value;
		}
		function onSplitTimeInc(e, id, inc) {
			var index = state.timecodes.findIndex(x => x.id === id);
			const timecode = state.timecodes[index];
			timecode.timestamp += inc;
			var elem = document.querySelector(`#splits > #split-${id} .time`);
			elem.textContent = formatTimeDelta(state.timecodes[0].timestamp, timecode.timestamp);
		}
		function onSplitCopy(id, format) {
			var index = state.timecodes.findIndex(x => x.id === id);
			const timecode = state.timecodes[index];
			const payload = renderTimeCodeClipboardItem(timecode, format);
			navigator.clipboard.writeText(payload);
		}
		function onSplitDelete(id) {
			var index = state.timecodes.findIndex(x => x.id === id);
			state.timecodes.splice(index, 1);

			var split = document.querySelector(`#splits > #split-${id}`);
			split.remove();
		}
		function makeExportButtons(onClick) {
			return configs.keys().filter(x => x.startsWith("export.") && x.endsWith("enabled"))
				.filter(x => configs.getBool(x))
				.map(x => x.replaceAll(/export\.([^.]+)\..*/g, '$1'))
				.map(index => {
					const exportButton = document.createElement('button');
					exportButton.innerHTML = '<img><span>';
					exportButton.querySelector('img').className = 'icon copy';
					exportButton.querySelector('img').src = 'copy.png';
					exportButton.querySelector('img').title = `Export ${configs.getString(`export.${index}.label`)}`;
					exportButton.querySelector('span').textContent = configs.getString(`export.${index}.label`);
					exportButton.addEventListener('click', () => onClick(configs.getString(`export.${index}.format`)));
					return exportButton;
			});
		}
		function renderSplit(timecode) {
			const split = document.createElement('div');
			split.id = `split-${timecode.id}`;
			split.className = 'split';

			const splitTimeDec = document.createElement('div');
			splitTimeDec.className = 'button dec';
			splitTimeDec.textContent = '-';
			splitTimeDec.addEventListener('click', (e) => onSplitTimeInc(e, timecode.id, -1000*configs.getInt('manualIncrement')));
			if (timecode === state.timecodes[0]) splitTimeDec.style.visibility = 'hidden';
			split.appendChild(splitTimeDec);

			const splitTime = document.createElement('div');
			splitTime.className = 'time';
			splitTime.textContent = formatTimeDelta(state.timecodes[0].timestamp, timecode.timestamp);
			split.appendChild(splitTime);

			const splitTimeInc = document.createElement('div');
			splitTimeInc.className = 'button inc';
			splitTimeInc.textContent = '+';
			splitTimeInc.addEventListener('click', (e) => onSplitTimeInc(e, timecode.id, 1000*configs.getInt('manualIncrement')));
			if (timecode === state.timecodes[0]) splitTimeInc.style.visibility = 'hidden';
			split.appendChild(splitTimeInc);

			const splitLabel = document.createElement('input');
			splitLabel.type = 'text';
			splitLabel.className = 'label';
			splitLabel.value = timecode.label;
			splitLabel.addEventListener('change', (e) => onSplitNameChange(e, timecode.id));
			split.appendChild(splitLabel);

			makeExportButtons(format => {
				onSplitCopy(timecode.id, format);
			}).forEach(button => split.appendChild(button));

			if (timecode !== state.timecodes[0]) {
				const deleteButton = document.createElement('img');
				deleteButton.className = 'button icon delete';
				deleteButton.src = 'delete.png';
				deleteButton.addEventListener('click', () => onSplitDelete(timecode.id));
				split.appendChild(deleteButton);
			}

			return split;
		}
		function render() {
			renderCurrentSplit();
			renderTotalTime();
		}
		function doSplit(name) {
			const timecode = TimeCode(now, name||configs.getString('newSplitName'));
			state.timecodes.push(timecode);
			const splits = document.querySelector('#splits');
			splits.appendChild(renderSplit(timecode));
		}
		function doRenderAllSplits() {
			const splits = document.querySelector('#splits');
			splits.innerHTML = '';
			state.timecodes.forEach(t => splits.appendChild(renderSplit(t)));
		}
		function doReset() {
			state.timecodes = state.timecodes = proxies.create([]);
			update();
			document.querySelector('#splits').innerHTML = '';
			doSplit(configs.getString('firstSplitName'));
		}
		function update() {
			const n = Date.now();
			const delta = n - state.fullPrecisionPreviousTime;
			state.fullPrecisionPreviousTime = n;
			state.fullPrecisionCurrentTime += delta;
			now = Math.floor(state.fullPrecisionCurrentTime/1000)*1000;
		}
		function doPause() {
			if (timer) {
				timer = clearInterval(timer);
				document.body.classList.add('running');
				document.body.classList.add('paused');
				document.querySelector('button[name=pause]').textContent = 'unpause';
			} else {
				state.fullPrecisionPreviousTime = Date.now();
				timer = setInterval(function() {
					update();
					render();
				}, 100);
				document.body.classList.remove('paused');
				document.body.classList.add('running');
				document.querySelector('button[name=pause]').textContent = 'pause';
			}
		}

		function onkeypress(e) {
			if (e.charCode == 32) {
				const isTextInput = document.activeElement && document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text';
				if (!isTextInput)
					doSplit();
			}
		}

		makeExportButtons(format => {
			onCopyAll(format);
		}).map(button => document.querySelector('#copyAll').appendChild(button));

		document.addEventListener('keypress', onkeypress);
		// document.querySelector('#copyAll').addEventListener('click', () => onCopyAll());
		document.querySelector('button[name=split]').addEventListener('click', (e) => {
			doSplit();
		});
		document.querySelector('button[name=reset]').addEventListener('click', (e) => {
			doReset()
		});
		document.querySelector('button[name=pause]').addEventListener('click', (e) => {
			doPause()
		});
		Array.from(document.querySelectorAll('button')).forEach(button => {
			button.addEventListener('click', (e) => {
				e.currentTarget.blur(); // reserve focus for global split toggle shortcut
			});
		});

		if (!state.timecodes.length)
			doReset();
		else
			doRenderAllSplits();
		doPause();
		if (!configs.getBool('startOnLoad'))
			doPause();
	</script>
</body>
</html>	
