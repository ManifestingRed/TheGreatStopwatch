<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="light.theme.css">
	<link rel="stylesheet" type="text/css" href="dark.theme.css">
	<style type="text/css">
		.table {
			display: table;
		}
		.tr {
			display: table-row;
		}
		.td {
			display: table-cell;
		}
	</style>
	<style type="text/css">
		.tabs > .tab {
			display:  none;
		}
		.tabs > .tab.active {
			display:  initial;
		}
		.tabs > .tabBar {
			border: solid 1px;
			border-color: var(--theme-tabs-border-color);
		}
		.tabs > .tabBar > .tabBarItem {
			display: inline-block;
			padding: 5px;
			border-right: solid 1px;
			color: var(--theme-tabs-text-color);
			border-color: var(--theme-tabs-tab-border-color);
		}
		.tabs > .tabBar > .tabBarItem:hover {
			background-color: var(--theme-tabs-tab-hover-background-color);
			cursor: pointer;
		}
	</style>
	<style type="text/css">
		.tab[data-title=config] .table .tr .td {
			padding: 5px;
		}
	</style>
	<style type="text/css">
		body {
			margin: 0;
			padding: 10px;
			border: 10px solid rgba(0,0,0,0);
			background-color: var(--theme-background-color);
			color: var(--theme-text-color);
		}
		body.paused {
			border: 10px solid;
			border-color: var(--theme-splits-paused-border-color);
		}
		.icon {
			width: 16px;
			height: 16px;
			vertical-align: middle;
		}

		.button {
			border: none;
			padding: 3px;
		}
		.button:hover, .button:focus {
			border: dashed 3px;
			border-color: var(--theme-button-hover-border-color);
			padding:  0px;
			cursor: pointer;
		}

		#splits {
			list-style-type: none;
		}
		.split .time {
			display: inline-block;
			min-width: 70px;
			text-align: center;
		}
		.split .dec {
			display: inline-block;
		}
		.split .inc {
			display: inline-block;
		}
		.split .name {
			display: inline-block;
			margin-left: 10px;
		}
		.split .icon {
			margin-left: 10px;
		}

		#currentSplit div {
			display: inline-block;
		}
		#currentSplit .name {
			min-width: 60px;
		}


		#totalTime div {
			display: inline-block;
		}
		#totalTime .name {
			min-width: 60px;
		}

		button {
			text-transform: uppercase;
		}
		#copyAll {
			vertical-align: text-bottom;
		}

		input[type=text] {
			border: dashed 1px;
		}
		input[type=text]:focus {
			border: initial;
			padding: 3px;
		}
		.info {
			white-space: pre;
			border: 1px dashed lightgrey;
			padding: 5px 10px 5px 10px;
			display: inline-block;
		}
	</style>
</head>
<body>
	<div class='tabs'>
		<div class='tabbar'></div>
		<div class='tab active' data-title='splits'>
			<div>Splits<img id='copyAll' title='Copy all' class='button icon' src='copy.png'></div> <ol id='splits'></ol>
			<div id='currentSplit'><div class='name'>Current</div><div class='time'></div></div>
			<div id='totalTime'><div class='name'>Total</div><div class='time'></div></div>
			<button name='reset'>reset</button>
			<button name='pause'>pause</button>
			<button name='split'>split</button>
		</div>
		<div class='tab' data-title='info'>
			<div class='info'><strong>Info</strong>
• Click descriptions to edit.
• Global shortcut 'spacebar' to split (when not editing description).
• <img id='copyAll' class='button icon' src='copy.png'> copies to clipboard.</div>
		</div>
		<div class='tab' data-title='config'>
			<div class='table config'>
				<div class='tr'><div class='td name'>Dark mode</div><input class='td' type='checkbox' name='darkMode' checked></div>
				<div class='tr'><div class='td name'>Start on load</div><input class='td' type='checkbox' name='startOnLoad'></div>
				<div class='tr'><div class='td name'>First split name</div><input class='td' type='text' name='firstSplitName' value='The Beginning'></div>
				<div class='tr'><div class='td name'>New split name</div><input class='td' type='text' name='newSplitName' value='New Split'></div>
				<div class='tr'><div class='td name'>Manual increment</div><input class='td' type='number' name='manualIncrement' value='1'></div>
				<div class='tr'><div class='td name'>Digit padding</div><input class='td' type='number' name='zeroPadding' value='2'></div>
			</ol>
		</div>
	</div>
	<script>
	</script>
	<script>
		const tabBar = document.querySelector('.tabbar');
		document.querySelectorAll('.tabs > .tab').forEach(tab => {
			const title = tab.getAttribute('data-title')
			const barItem = document.createElement('div');
			barItem.className = 'tabBarItem';
			barItem.textContent = title;
			barItem.addEventListener('click', function() {
				const active = document.querySelector('.tabs > .tab.active');
				if (active) active.className = 'tab';
				tab.className = 'tab active';
			});

			tabBar.appendChild(barItem);
		});
	</script>
	<script>
		const configs = {};
		configs.getBoolOpt = name => window.localStorage.getItem(`config.${name}`);
		configs.getBool = name => window.localStorage.getItem(`config.${name}`) === 'true';
		configs.setBool = (name, value) => window.localStorage.setItem(`config.${name}`, !!value);
		configs.getString = name => window.localStorage.getItem(`config.${name}`);
		configs.setString = (name, value) => window.localStorage.setItem(`config.${name}`, value==null?null:value.toString());
		configs.getIntOpt = name => window.localStorage.getItem(`config.${name}`);
		configs.getInt = name => parseInt(window.localStorage.getItem(`config.${name}`));
		configs.setInt = (name, value) => window.localStorage.setItem(`config.${name}`, parseInt(value));

		configs.updaters = {
			darkMode: () => {
				const theme = configs.getBool('darkMode')?'theme-dark':'theme-light';
				Array.from(document.documentElement.classList.values())
					.filter(x => x.startsWith('theme-'))
					.forEach(x => document.documentElement.classList.remove(x));
				document.documentElement.classList.add(theme);
			},
			startOnLoad: () => {
			}
		};

		document.querySelectorAll('.tab[data-title=config] input[type=checkbox]').forEach(config => {
			if (configs.getBoolOpt(config.name) === null) {
				configs.setBool(config.name, config.checked);
			}
			const value = configs.getBool(config.name);
			config.checked = value;
			const updater = configs.updaters[config.name];
			updater && updater();
		});
		document.querySelectorAll('.tab[data-title=config] input[type=checkbox]').forEach(config => {
			config.addEventListener('change', function() {
				configs.setBool(config.name, !!config.checked);
				const updater = configs.updaters[config.name];
				updater && updater();
			});
		});

		document.querySelectorAll('.tab[data-title=config] input[type=text]').forEach(config => {
			if (configs.getString(config.name) === null) {
				configs.setString(config.name, config.value);
			}
			const value = configs.getString(config.name);
			config.value = value;
			const updater = configs.updaters[config.name];
			updater && updater();
		});
		document.querySelectorAll('.tab[data-title=config] input[type=text]').forEach(config => {
			config.addEventListener('change', function() {
				configs.setString(config.name, config.value);
				const updater = configs.updaters[config.name];
				updater && updater();
			});
		});

		document.querySelectorAll('.tab[data-title=config] input[type=number]').forEach(config => {
			if (configs.getIntOpt(config.name) === null) {
				configs.setInt(config.name, config.value);
			}
			const value = configs.getInt(config.name);
			config.value = value;
			const updater = configs.updaters[config.name];
			updater && updater();
		});
		document.querySelectorAll('.tab[data-title=config] input[type=number]').forEach(config => {
			config.addEventListener('change', function() {
				configs.setInt(config.name, config.value);
				const updater = configs.updaters[config.name];
				updater && updater();
			});
		});
	</script>
	<script>
		function timeBetween(start, end) {
			var delta = (end - start);
			var millis = Math.floor(delta%1000);
			var seconds = Math.floor(delta/1000)%60;
			var minutes = Math.floor((delta/(60*1000))%60);
			var hours = Math.floor((delta/(60*60*1000))%24);
			var days = Math.floor((delta/(60*60*1000))/24);
			return {
				millis,
				seconds,
				minutes,
				hours,
				days
			};
		}
		function formatTimeDelta(from, to) {
			const pad = x => x.toString().padStart(configs.getInt('zeroPadding'), '0');
			const delta = timeBetween(from, to);
			const formatted = `${pad(delta.days)}:${pad(delta.hours)}:${pad(delta.minutes)}:${pad(delta.seconds)}`;
			return formatted;
		}
		function TimeCode(time, name) {
			return { id:(++timecodeIdCounter) , time, name };
		}

		let timer = null;
		let fullPrecisionPreviousTime = Date.now();
		let fullPrecisionCurrentTime = Date.now();
		let now = Date.now();
		let timecodeIdCounter = 0;
		let timecodes = [];

		function renderCurrentSplit() {
			document.querySelector('#currentSplit .time').textContent = formatTimeDelta(timecodes[timecodes.length-1].time, now);
		}
		function renderTotalTime() {
			document.querySelector('#totalTime .time').textContent = formatTimeDelta(timecodes[0].time, now);
		}
		function renderTimeCodeClipboardItem(timecode) {
			const payload = {
				...timecode,
				formattedTime: formatTimeDelta(timecodes[0].time, timecode.time) 
			};
			return payload;
		}
		function onCopyAll() {
			const rendered = timecodes.map(x => renderTimeCodeClipboardItem(x));
			const payload = {
				splits: rendered
			};
			navigator.clipboard.writeText(JSON.stringify(payload));
		}
		function onSplitNameChange(e, id) {
			var index = timecodes.findIndex(x => x.id === id);
			const timecode = timecodes[index];
			timecode.name = e.currentTarget.value;
		}
		function onSplitTimeInc(e, id, inc) {
			var index = timecodes.findIndex(x => x.id === id);
			const timecode = timecodes[index];
			timecode.time += inc;
			var elem = document.querySelector(`#splits > #split-${id} .time`);
			elem.textContent = formatTimeDelta(timecodes[0].time, timecode.time);
		}
		function onSplitCopy(id) {
			var index = timecodes.findIndex(x => x.id === id);
			const timecode = timecodes[index];
			const payload = renderTimeCodeClipboardItem(timecode);
			navigator.clipboard.writeText(JSON.stringify(payload));
		}
		function onSplitDelete(id) {
			var index = timecodes.findIndex(x => x.id === id);
			timecodes.splice(index, 1);

			var split = document.querySelector(`#splits > #split-${id}`);
			split.remove();
		}
		function renderSplit(timecode) {
			const split = document.createElement('div');
			split.id = `split-${timecode.id}`;
			split.className = 'split';

			const splitTimeDec = document.createElement('div');
			splitTimeDec.className = 'button dec';
			splitTimeDec.textContent = '-';
			splitTimeDec.addEventListener('click', (e) => onSplitTimeInc(e, timecode.id, -1000*configs.getInt('manualIncrement')));
			if (timecode === timecodes[0]) splitTimeDec.style.visibility = 'hidden';
			split.appendChild(splitTimeDec);

			const splitTime = document.createElement('div');
			splitTime.className = 'time';
			splitTime.textContent = formatTimeDelta(timecodes[0].time, timecode.time);
			split.appendChild(splitTime);

			const splitTimeInc = document.createElement('div');
			splitTimeInc.className = 'button inc';
			splitTimeInc.textContent = '+';
			splitTimeInc.addEventListener('click', (e) => onSplitTimeInc(e, timecode.id, 1000*configs.getInt('manualIncrement')));
			if (timecode === timecodes[0]) splitTimeInc.style.visibility = 'hidden';
			split.appendChild(splitTimeInc);

			const splitName = document.createElement('input');
			splitName.type = 'text';
			splitName.className = 'name';
			splitName.value = timecode.name;
			splitName.addEventListener('change', (e) => onSplitNameChange(e, timecode.id));
			split.appendChild(splitName);

			const copyButton = document.createElement('img');
			copyButton.className = 'button icon copy';
			copyButton.src = 'copy.png';
			copyButton.title = 'Copy';
			copyButton.addEventListener('click', () => onSplitCopy(timecode.id));
			split.appendChild(copyButton);

			if (timecode !== timecodes[0]) {
				const deleteButton = document.createElement('img');
				deleteButton.className = 'button icon delete';
				deleteButton.src = 'delete.png';
				deleteButton.addEventListener('click', () => onSplitDelete(timecode.id));
				split.appendChild(deleteButton);
			}

			return split;
		}
		function render() {
			renderCurrentSplit();
			renderTotalTime();
		}
		function doSplit(name) {
			const timecode = TimeCode(now, name||configs.getString('newSplitName'));
			timecodes.push(timecode);
			const splits = document.querySelector('#splits');
			splits.appendChild(renderSplit(timecode));
		}
		function doReset() {
			timecodes = [];
			update();
			document.querySelector('#splits').innerHTML = '';
			doSplit(configs.getString('firstSplitName'));
		}
		function update() {
			const n = Date.now();
			const delta = n - fullPrecisionPreviousTime;
			fullPrecisionPreviousTime = n;
			fullPrecisionCurrentTime += delta;
			now = Math.floor(fullPrecisionCurrentTime/1000)*1000;
		}
		function doPause() {
			if (timer) {
				timer = clearInterval(timer);
				document.body.classList.add('running');
				document.body.classList.add('paused');
				document.querySelector('button[name=pause]').textContent = 'unpause';
			} else {
				fullPrecisionPreviousTime = Date.now();
				timer = setInterval(function() {
					update();
					render();
				}, 100);
				document.body.classList.remove('paused');
				document.body.classList.add('running');
				document.querySelector('button[name=pause]').textContent = 'pause';
			}
		}

		function onkeypress(e) {
			if (e.charCode == 32) {
				const isTextInput = document.activeElement && document.activeElement.tagName === 'INPUT' && document.activeElement.type === 'text';
				if (!isTextInput)
					doSplit();
			}
		}

		document.addEventListener('keypress', onkeypress);
		document.querySelector('#copyAll').addEventListener('click', () => onCopyAll());
		document.querySelector('button[name=split]').addEventListener('click', (e) => {
			doSplit();
		});
		document.querySelector('button[name=reset]').addEventListener('click', (e) => {
			doReset()
		});
		document.querySelector('button[name=pause]').addEventListener('click', (e) => {
			doPause()
		});
		Array.from(document.querySelectorAll('button')).forEach(button => {
			button.addEventListener('click', (e) => {
				e.currentTarget.blur(); // reserve focus for global split toggle shortcut
			});
		});

		doReset();
		doPause();
		if (!configs.getBool('startOnLoad'))
			doPause();
	</script>
</body>
</html>	
